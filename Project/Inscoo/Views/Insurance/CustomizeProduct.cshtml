@model Models.Insurance.CustomProductModel

@{
    ViewBag.Title = "自选产品";
}
<div class="panel-body">
    <div class="describe_name describe_name_expand">投保类型</div>
    <ul id="myTab" class="nav nav-tabs">
        <li class="myTab-title"><i class="fa fa-folder-open-o" style="margin-right:5px;color:#666"></i>保险公司<i class="fa fa-caret-down" style="color:#666;margin-left:5px"></i></li>
        @{
            if (Model.CompanyList.Count > 0)
            {
                int i = 0;
                foreach (var s in Model.CompanyList.OrderBy(s => s.Sequence))
                {
                    if (i == 0)
                    {
                        <li class="active">
                            <a href="#@s.Value" data-toggle="tab">@s.Key</a>
                        </li>
                    }
                    else
                    {
                        <li>
                            <a href="#@s.Value" data-toggle="tab">@s.Key</a>
                        </li>
                    }
                    i++;
                }
            }
        }
    </ul>
    <div class="tab-content">
        @{
            var n = 0;
            var compangName = "";
            foreach (var s in Model.CompanyList.OrderBy(s => s.Sequence))
            {
                var radioName = "ProductType_" + s.Value;//产品类型ID
                var ProductName = "Product_" + s.Value;//产品列表ID
                var staffsNumName = "StaffsNumber_" + s.Value;//员工数量ID
                var AvarageName = "Avarage_" + s.Value;//平均年龄ID
                var isShow = "";
                var onchangeFun = "getProduct(c='" + s.Value + "',p=0)";
                var changeCon = "changeCon('" + s.Value + "');";
                var changeAge = "changeAge('" + s.Value + "');";
                if (n == 0)
                {
                    isShow = " in active";
                }
                compangName += "getPriceAndIds(c='" + s.Value + "',e=1);getPriceAndIds(c='" + s.Value + "',e=2);getPriceAndIds(c='" + s.Value + "',e=3);";
                <div class="tab-pane fade @isShow" id="@s.Value">
                    <div class="programme-query">
                        <div class="programme-query-list" style="height:auto;padding-top:20px;">
                                @if (s.Value == "YAIC")
                                {
                                    <p style="border:1px solid #f00;border-radius:3px;padding:0 3px;margin-right:20px;color:#f00;line-height:30px;">永安保险：1996年成立，资金实力雄厚，健康险性价比高，全程线上投保，简单便捷，500元以下赔案金额可以微信理赔，无需提供发票原件。</p>
                                }
                                else if (s.Value == "CHINALIFE")
                                {
                                    <p style="border:1px solid #f00;border-radius:3px;padding:0 3px;margin-right:20px;color:#f00;line-height:30px;">中国人寿保险公司：A股上市，信誉保障，风控强，线上可完成投保，须寄送投保资料原件，理赔须提供发票原件。</p>
                                }
                                else if (s.Value == "PICC")
                                {
                                    <p style="border:1px solid #f00;border-radius:3px;padding:0 3px;margin-right:20px;color:#f00;line-height:30px;">中国人民保险公司：港股上市，健康险方案灵活，线上可完成投保，须补寄投保资料原件，理赔须提供发票原件。</p>
                                }
                        </div>
                        <div class="programme-query-list">
                            <b>请选择保险类别：</b>
                            <label class="checkbox-inline">
                                <input type="radio" name=@radioName value="员工福利保险" checked="checked" onchange="getProduct('@Html.Raw(s.Value)', this.value)" />
                                员工福利保险
                            </label>
                            <label class="checkbox-inline">
                                <input type="radio" name=@radioName value="雇主责任保险" onchange="getProduct('@Html.Raw(s.Value)', this.value)" />
                                雇主责任保险
                            </label>
                        </div>
                        <div class="programme-query-list">
                            <b>请选择投保信息：</b>
                            <label class="checkbox-inline">
                                @Html.DisplayNameFor(m => m.StaffsNumber)
                                @Html.DropDownList(staffsNumName, Model.StaffsNumber, new { onchange = Html.Raw(changeCon) })
                            </label>
                            <label class="checkbox-inline">
                                @Html.DisplayNameFor(m => m.Avarage)
                                @Html.DropDownList(AvarageName, Model.Avarage, new { onchange = Html.Raw(changeAge) })
                            </label>
                        </div>
                    </div>
                    <div id="@ProductName">
                        @Html.Action("ProductList", new { company = s.Value, })
                    </div>
                </div>
                n++;
            }
            @section scripts{
                <script>
                    $(document).ready(function () {
                        @Html.Raw(compangName)
                    });

                    function changeAge(c) {
                        for (var i = 1; i < 12; i++) {
                            getPriceAndIds(c, i);
                        }
                    }
                    function changeCon(c) {
                        var prodType = $('input[name="ProductType_' + c + '"]:checked').val();
                        console.log(c + '/' + prodType);
                        getProduct(c, prodType);
                    }
                    function getProduct(e, p) {
                        if (p == "0") {
                            var p = $('input[name="ProductType_' + e + '"]:checked').val()
                        }
                        var stuffsNum = $("#StaffsNumber_" + e).val();
                        $.ajax({
                            type: 'get',
                            url: '/Insurance/ProductList',
                            data: { company: e, productType: p, stuffsNum: stuffsNum },
                            success: function (da) {
                                document.getElementById('Product_' + e).innerHTML = da;
                                getPriceAndIds(e, 1);
                            }
                        });
                    }
                    function getPriceAndIds(c, e) {
                        var isChecked = $("#check_" + c + "_" + e).is(':checked');
                        if (isChecked) {
                            var cove = $("#CoverageSum_" + c + "_" + e).val();
                            var payrat = $("#PayoutRatio" + c + "_" + e).val();
                            var price = $("#price" + c + "_" + e);
                            var idname = $("#id" + c + "_" + e);
                            var StaffsNumber = $("#StaffsNumber_" + c).val();
                            var AvarageName = $("#Avarage_" + c).val();
                            var data = "";
                            var StaffsNumCart = "#StaffsNum_" + c;
                            var AvarageCart = "#AvarageCart_" + c;
                            if (typeof (payrat) == "undefined") {
                                data = { cid: cove, staffsNumber: StaffsNumber, avarage: AvarageName };
                            }
                            else {
                                data = { cid: cove, payrat: payrat, staffsNumber: StaffsNumber, avarage: AvarageName };
                            }
                            $.ajax({
                                type: 'post',
                                url: '/Insurance/GetProductPrice',
                                data: data,
                                success: function (da) {
                                    var pr = parseFloat(da.Price);
                                    var id = parseInt(da.Id);
                                    if (typeof (pr) == "number" && !isNaN(pr) && typeof (id) == "number") {
                                        price.text(pr);
                                        idname.val(id);
                                    }
                                    else {
                                        price.text("无可选产品");
                                        idname.val("0");
                                    }
                                    reckonAmount(c);
                                    reckonIds(c);
                                    $(StaffsNumCart).val(StaffsNumber);
                                    $(AvarageCart).val(AvarageName);
                                }
                            });
                        }
                        else {
                            $("#price" + c + "_" + e).text("0.00");
                            $("#id" + c + "_" + e).val("0");
                            reckonAmount(c);
                        }
                    }
                    function reckonIds(e) {
                        var ids = new Array();
                        for (var i = 1; i < 20; i++) {
                            var idname = "#id" + e + "_" + i;
                            var id = parseInt($(idname).val());

                            if (typeof (id) == "number" && !isNaN(id)) {
                                if (id > 0) {
                                    ids.push(id);
                                }
                            }
                        }
                        $("#productIds_" + e).val(ids);
                    }
                    function reckonAmount(e) {
                        var total = 0;
                        for (var i = 1; i < 20; i++) {
                            var pname = "#price" + e + "_" + i;
                            var price = parseFloat($(pname).text());
                            if (typeof (price) == "number" && !isNaN(price)) {
                                total += parseFloat(price);
                            }
                        }
                        $("#total_" + e).text(total.toFixed(2));
                        $("#Price_" + e + "_Model").val(total.toFixed(2));
                    }
                </script>
            }
        }
    </div>
</div>
