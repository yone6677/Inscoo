@model Models.Insurance.CustomProductModel

@{
    ViewBag.Title = "自选产品";
}
<div class="panel-body">
    <div class="describe_name">投保类型</div>
    <ul id="myTab" class="nav nav-tabs">
        @{
            if (Model.CompanyList.Count > 0)
            {
                int i = 0;
                foreach (var s in Model.CompanyList)
                {
                    if (i == 0)
                    {
                        <li class="active">
                            <a href="#@s.Value" data-toggle="tab">@s.Key</a>
                        </li>
                    }
                    else
                    {
                        <li>
                            <a href="#@s.Value" data-toggle="tab">@s.Key</a>
                        </li>
                    }
                    i++;
                }
            }
        }
    </ul>
    <div class="tab-content">
        @{
            var n = 0;
            var compangName = "";
            foreach (var s in Model.CompanyList)
            {
                var radioName = "ProductType_" + s.Value;//产品类型ID
                var ProductName = "Product_" + s.Value;//产品列表ID
                var staffsNumName = "StaffsNumber_" + s.Value;//员工数量ID
                var AvarageName = "Avarage_" + s.Value;//平均年龄ID
                var isShow = "";
                var onchangeFun = "getProduct(c='" + s.Value + "',p=0)";
                var changeCon = "changeCon('" + s.Value + "');";
                var changeAge = "changeAge('" + s.Value + "');";
                if (n == 0)
                {
                    isShow = " in active";
                }
                compangName += "getPriceAndIds(c='" + s.Value + "',e=1);getPriceAndIds(c='" + s.Value + "',e=2);getPriceAndIds(c='" + s.Value + "',e=3);";
                <div class="tab-pane fade @isShow" id="@s.Value">
                    <div class="programme-query">
                        <label class="checkbox-inline">
                            <input type="radio" name=@radioName value="员工福利保险" checked="checked" onchange="getProduct('@Html.Raw(s.Value)', this.value)" />
                            员工福利保险
                        </label>
                        <label class="checkbox-inline">
                            <input type="radio" name=@radioName value="雇主责任保险" onchange="getProduct('@Html.Raw(s.Value)', this.value)" />
                            雇主责任保险
                        </label>
                        <label class="checkbox-inline">
                            @Html.DisplayNameFor(m => m.StaffsNumber)
                            @Html.DropDownList(staffsNumName, Model.StaffsNumber, new { onchange = Html.Raw(changeCon) })
                        </label>
                        <label class="checkbox-inline">
                            @Html.DisplayNameFor(m => m.Avarage)
                            @Html.DropDownList(AvarageName, Model.Avarage, new { onchange = Html.Raw(changeAge) })
                        </label>
                    </div>
                    <div id="@ProductName">
                        @Html.Action("ProductList", new { company = s.Value, })
                    </div>
                </div>
                n++;
            }
            @section scripts{
                <script>
                    $(document).ready(function () {
                        @Html.Raw(compangName)
                    });

                    function changeAge(c) {
                        for (var i = 1; i < 12; i++) {
                            getPriceAndIds(c, i);
                        }
                    }
                    function changeCon(c) {
                        var prodType = $("#" + "ProductType_" + c).val();
                        getProduct(c, prodType);
                    }
                    function getProduct(e, p) {
                        if (p == "0") {
                            var radioName = "ProductType_" + e;
                            p = $("#" + radioName).val();
                        }
                        var stuffsNum = $("#StaffsNumber_" + e).val();
                        $.ajax({
                            type: 'get',
                            url: '/Insurance/ProductList',
                            data: { company: e, productType: p, stuffsNum: stuffsNum },
                            success: function (da) {
                                document.getElementById('Product_' + e).innerHTML = da;
                                getPriceAndIds(e, 1);
                            }
                        });
                    }
                    function getPriceAndIds(c, e) {
                        var isChecked = $("#check_" + c + "_" + e).is(':checked');
                        if (isChecked) {
                            var cove = $("#CoverageSum_" + c + "_" + e).val();
                            var payrat = $("#PayoutRatio" + c + "_" + e).val();
                            var price = $("#price" + c + "_" + e);
                            var idname = $("#id" + c + "_" + e);
                            var StaffsNumber = $("#StaffsNumber_" + c).val();
                            var AvarageName = $("#Avarage_" + c).val();
                            var data = "";
                            var StaffsNumCart = "#StaffsNum_" + c;
                            var AvarageCart = "#AvarageCart_" + c;
                            if (typeof (payrat) == "undefined") {
                                data = { cid: cove, staffsNumber: StaffsNumber, avarage: AvarageName };
                            }
                            else {
                                data = { cid: cove, payrat: payrat, staffsNumber: StaffsNumber, avarage: AvarageName };
                            }
                            $.ajax({
                                type: 'post',
                                url: '/Insurance/GetProductPrice',
                                data: data,
                                success: function (da) {
                                    var pr = parseFloat(da.Price);
                                    var id = parseInt(da.Id);
                                    if (typeof (pr) == "number" && !isNaN(pr) && typeof (id) == "number") {
                                        price.text(pr);
                                        idname.val(id);
                                    }
                                    else {
                                        price.text("无可选产品");
                                        idname.val("0");
                                    }
                                    reckonAmount(c);
                                    reckonIds(c);
                                    $(StaffsNumCart).val(StaffsNumber);
                                    $(AvarageCart).val(AvarageName);
                                }
                            });
                        }
                        else {
                            $("#price" + c + "_" + e).text("0.00");
                            $("#id" + c + "_" + e).val("0");
                            reckonAmount(c);
                        }
                    }
                    function reckonIds(e) {
                        var ids = new Array();
                        for (var i = 1; i < 20; i++) {
                            var idname = "#id" + e + "_" + i;
                            var id = parseInt($(idname).val());

                            if (typeof (id) == "number" && !isNaN(id)) {
                                if (id > 0) {
                                    ids.push(id);
                                }
                            }
                        }
                        $("#productIds_" + e).val(ids);
                    }
                    function reckonAmount(e) {
                        var total = 0;
                        for (var i = 1; i < 20; i++) {
                            var pname = "#price" + e + "_" + i;
                            var price = parseFloat($(pname).text());
                            if (typeof (price) == "number" && !isNaN(price)) {
                                total += parseFloat(price);
                            }
                        }
                        $("#total_" + e).text(total.toFixed(2));
                        $("#Price_" + e + "_Model").val(total.toFixed(2));
                    }
                </script>
            }
        }
    </div>
</div>
