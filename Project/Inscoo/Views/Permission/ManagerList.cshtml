@model IEnumerable<Models.Permission.vPermissionNav>

@{
    ViewBag.Title = "分配权限";
}
<table class="table">
    <tr>
        <th>
            @Html.DisplayNameFor(model => model.Name)
        </th>
        <th>
            @Html.DisplayNameFor(model => model.Controller)
        </th>
        <th>
            @Html.DisplayNameFor(model => model.Action)
        </th>
        <th>
            @Html.DisplayNameFor(model => model.IsUsed)
        </th>
        <th></th>
    </tr>
    @if (Model != null)
    {
        foreach (var item in Model)
        {
            <tr>
                <td>
                    @Html.DisplayFor(modelItem => item.Name)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Controller)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.Action)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.IsUsed)
                </td>
                <td>
                    @if (item.CanEdit)
                    {
                        if (item.IsUsed)
                        {
                            <a href="javascript:" onclick="Manage('@item.Action', 'DeletePermission')">取消</a>
                        }
                        else
                        {
                            <a href="javascript:" onclick="Manage('@item.Action', 'AddPermission')">添加</a>
                        }
                    }
                </td>
            </tr>
        }
    }
</table>
<script type="text/javascript">

    function Manage(action, type) {
        var roleId = jQuery("#roleId").val();
        var control = jQuery("#control").val();
        var checkbox = event.target.parentNode.previousElementSibling.children[0];
        var lastTd = event.target.parentNode;
        $.ajax({
            url: type,
            type: "post",    //数据发送方式
            async: false,
            data: { "Controller": control, "Action": action, "roleId": roleId },
            dataType: "json",   //接受数据格式
            error: function () {
                alert("服务器没有返回数据，可能服务器忙，请重试");
            },
            success: function (result) {
                //console.log(result);
                //console.log(event);
                if (result.result) {
                    //console.log(checkbox);
                    if (type == 'AddPermission') {
                        jQuery(checkbox).attr("checked", "checked");
                        jQuery(lastTd).html("");
                    }
                    else {
                        jQuery(checkbox).removeAttr("checked");
                        jQuery(lastTd).html("");
                    }
                }
            }
        });
    }
</script>
